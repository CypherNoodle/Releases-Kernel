name: Kernel Debian Ultra-Compact ThinLTO + ZSTD + Clang Opt (v2)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  SCCACHE_DIR: ${{ github.workspace }}/.sccache
  KSRC: ${{ github.workspace }}/kernel-src
  LLVM_VERSION: 19

jobs:
  build-kernel:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # CHECKOUT DEL KERNEL (USARÁ TU .config SIN MODIFICAR)
      # ----------------------------------------------------
      - name: Checkout kernel repo
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src
          fetch-depth: 0

      # Debug inicial .config
      - name: Mostrar .config real (debug)
        working-directory: ${{ github.workspace }}/kernel-src
        run: |
          echo "===== .config REAL DEL REPO ====="
          ls -l .config
          head -n 20 .config
          md5sum .config > ../config_pre.md5
          echo "MD5 inicial guardado."

      # ----------------------------------------------------
      # NPROC
      # ----------------------------------------------------
      - name: Calcular recursos (nproc)
        id: calc
        run: |
          echo "p=$(nproc)" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # CACHE SCCACHE
      # ----------------------------------------------------
      - name: Restaurar Cache de SCCACHE
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: sccache-${{ runner.os }}-clang-${{ env.LLVM_VERSION }}

      # ----------------------------------------------------
      # DEPENDENCIAS
      # ----------------------------------------------------
      - name: Instalar dependencias
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}

          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
            libncurses-dev debhelper dwarves zstd sccache xz-utils util-linux \
            fakeroot dpkg-dev cpio lld-${{ env.LLVM_VERSION }} \
            llvm-${{ env.LLVM_VERSION }} llvm-${{ env.LLVM_VERSION }}-tools

          sudo ln -sf /usr/bin/ld.lld-${{ env.LLVM_VERSION }} /usr/bin/ld.lld

          echo "SCCACHE_DIR=${{ env.SCCACHE_DIR }}" >> $GITHUB_ENV
          echo "SCCACHE_LOG=info" >> $GITHUB_ENV
          echo "${{ github.workspace }}/.sccache" >> $GITHUB_PATH

      # ----------------------------------------------------
      # IMPORTANTE: NO TOCAR .config
      # ----------------------------------------------------
      - name: Confirmar que NO se regenera .config
        working-directory: ${{ env.KSRC }}
        run: |
          echo "No se ejecutará oldconfig ni olddefconfig."
          echo "Se usará tu .config EXACTO del repositorio."

      # ----------------------------------------------------
      # COMPILACIÓN (ThinLTO + Flags sin modificar .config)
      # ----------------------------------------------------
      - name: Build Kernel
        working-directory: ${{ env.KSRC }}
        env:
          CC: "sccache clang-${{ env.LLVM_VERSION }}"
          HOSTCC: "clang-${{ env.LLVM_VERSION }}"
          HOSTCXX: "clang++-${{ env.LLVM_VERSION }}"
          LD: "ld.lld-${{ env.LLVM_VERSION }}"
          CFLAGS_KERNEL: -O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing
          KCFLAGS: -O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing
          LLVM: 1
        run: |
          make -j${{ steps.calc.outputs.p }} \
            LLVM=1 \
            LTO=thin \
            KBUILD_BUILD_TIMESTAMP="" \
            bindeb-pkg LOCALVERSION="-${{ github.run_number }}-opt"

      # ----------------------------------------------------
      # VERIFICAR QUE .config NO FUE ALTERADO
      # ----------------------------------------------------
      - name: Comparar MD5 del .config antes y después
        working-directory: ${{ env.KSRC }}
        run: |
          echo "MD5 actual:"
          md5sum .config
          md5sum .config > ../config_post.md5

          echo "Comparando..."
          if diff ../config_pre.md5 ../config_post.md5; then
            echo "OK: El .config NO cambió."
          else
            echo "ERROR: El .config fue modificado!"
            exit 1
          fi

      # ----------------------------------------------------
      # SHA256 + CHANGELOG
      # ----------------------------------------------------
      - name: SHA256 + CHANGELOG
        working-directory: ${{ env.KSRC }}
        run: |
          rm -rf ../debout
          mkdir -p ../debout
          mv ../*.deb ../debout/

          cd ../debout
          sha256sum *.deb > SHA256SUMS.txt

          PREV=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")
          if [ -n "$PREV" ]; then
            git log "$PREV"..HEAD --pretty=format:"%h - %s" > CHANGELOG.txt
          else
            git log --reverse --max-count=30 --pretty=format:"%h - %s" > CHANGELOG.txt
          fi

      # ----------------------------------------------------
      # RELEASE
      # ----------------------------------------------------
      - name: Publicar Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            debout/*.deb
            debout/SHA256SUMS.txt
            debout/CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
