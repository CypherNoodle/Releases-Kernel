name: Build Kernel (.deb) and Upload Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # Checkout kernel source
      # ------------------------------------------------------------
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src
          fetch-depth: 0

      # ------------------------------------------------------------
      # Detect kernel version
      # ------------------------------------------------------------
      - name: Detect Kernel Version
        id: detect_version
        working-directory: kernel-src
        run: |
          KERNEL_VERSION=$(awk '
            /^VERSION = /      {v=$3}
            /^PATCHLEVEL = /   {p=$3}
            /^SUBLEVEL = /     {s=$3}
            /^EXTRAVERSION = / {e=$3}
            END {print v "." p "." s e}
          ' Makefile)
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "Detected kernel version: $KERNEL_VERSION"

      # ------------------------------------------------------------
      # Cache de dependencias APT
      # ------------------------------------------------------------
      - name: Restore APT cache
        uses: actions/cache/restore@v4
        id: apt-restore
        with:
          path: ~/apt-cache
          key: apt-${{ runner.os }}-v3
          restore-keys: |
            apt-${{ runner.os }}-
            apt-

      # ------------------------------------------------------------
      # Install build dependencies
      # ------------------------------------------------------------
      - name: Install build dependencies
        run: |
          if [ -d ~/apt-cache ]; then
            echo "Restoring APT cache..."
            sudo cp -r ~/apt-cache/* /var/cache/apt/archives/ 2>/dev/null || true
          fi
          
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc libssl-dev libelf-dev libncurses-dev \
            debhelper kmod cpio ccache libdw-dev
          
          echo "Saving APT cache..."
          mkdir -p ~/apt-cache
          sudo cp -r /var/cache/apt/archives/*.deb ~/apt-cache/ 2>/dev/null || true

      # ------------------------------------------------------------
      # Save APT cache
      # ------------------------------------------------------------
      - name: Save APT cache
        uses: actions/cache/save@v4
        if: always() && steps.apt-restore.outputs.cache-hit != 'true'
        with:
          path: ~/apt-cache
          key: ${{ steps.apt-restore.outputs.cache-primary-key }}

      # ------------------------------------------------------------
      # Restore ccache - BUSCA EN TODOS LOS BRANCHES/TAGS
      # ------------------------------------------------------------
      - name: Restore ccache
        uses: actions/cache/restore@v4
        id: ccache-restore
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
            ccache-${{ runner.os }}-6.19.
            ccache-${{ runner.os }}-6.
            ccache-${{ runner.os }}-
            ccache-

      # ------------------------------------------------------------
      # Restore kernel metadata
      # ------------------------------------------------------------
      - name: Restore kernel metadata
        uses: actions/cache/restore@v4
        id: kernel-meta-restore
        with:
          path: |
            kernel-src/.config
            kernel-src/include/config/
            kernel-src/include/generated/
            kernel-src/arch/*/include/generated/
            kernel-src/Module.symvers
            kernel-src/.version
          key: kernel-meta-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}
          restore-keys: |
            kernel-meta-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
            kernel-meta-${{ runner.os }}-6.19.
            kernel-meta-${{ runner.os }}-6.
            kernel-meta-${{ runner.os }}-
            kernel-meta-

      # ------------------------------------------------------------
      # Restore kernel build tools
      # ------------------------------------------------------------
      - name: Restore kernel build tools
        uses: actions/cache/restore@v4
        id: kernel-tools-restore
        with:
          path: |
            kernel-src/scripts/basic/
            kernel-src/scripts/kconfig/
            kernel-src/scripts/mod/
            kernel-src/tools/objtool/
          key: kernel-tools-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}
          restore-keys: |
            kernel-tools-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
            kernel-tools-${{ runner.os }}-6.19.
            kernel-tools-${{ runner.os }}-6.
            kernel-tools-${{ runner.os }}-
            kernel-tools-

      # ------------------------------------------------------------
      # VERIFICAR RESTAURACIÃ“N DE CACHE
      # ------------------------------------------------------------
      - name: Check cache restoration
        run: |
          echo "=========================================="
          echo "CACHE RESTORATION STATUS"
          echo "=========================================="
          echo "Build: #${{ github.run_number }}"
          echo "Ref: ${{ github.ref }}"
          echo "Tag: ${{ github.ref_name }}"
          echo ""
          
          # ccache
          echo "1ï¸âƒ£  CCACHE:"
          if [ -n "${{ steps.ccache-restore.outputs.cache-matched-key }}" ]; then
            echo "   âœ… RESTORED from: ${{ steps.ccache-restore.outputs.cache-matched-key }}"
            if [ -d ~/.ccache ]; then
              SIZE=$(du -sh ~/.ccache 2>/dev/null | cut -f1)
              FILES=$(find ~/.ccache -type f 2>/dev/null | wc -l)
              echo "   ðŸ“¦ Size: $SIZE"
              echo "   ðŸ“„ Files: $FILES"
            fi
          else
            echo "   âŒ NOT FOUND - This will be a FULL BUILD (~50 min)"
          fi
          echo ""
          
          # kernel metadata
          echo "2ï¸âƒ£  KERNEL METADATA:"
          if [ -n "${{ steps.kernel-meta-restore.outputs.cache-matched-key }}" ]; then
            echo "   âœ… RESTORED from: ${{ steps.kernel-meta-restore.outputs.cache-matched-key }}"
            [ -f kernel-src/.config ] && echo "   âœ“ .config available"
            [ -f kernel-src/Module.symvers ] && echo "   âœ“ Module.symvers available"
            [ -d kernel-src/include/generated ] && echo "   âœ“ Generated headers available"
          else
            echo "   âŒ NOT FOUND"
          fi
          echo ""
          
          # kernel tools
          echo "3ï¸âƒ£  KERNEL BUILD TOOLS:"
          if [ -n "${{ steps.kernel-tools-restore.outputs.cache-matched-key }}" ]; then
            echo "   âœ… RESTORED from: ${{ steps.kernel-tools-restore.outputs.cache-matched-key }}"
            [ -x kernel-src/scripts/basic/fixdep ] && echo "   âœ“ Compiled tools available"
          else
            echo "   âŒ NOT FOUND"
          fi
          echo ""
          
          # PredicciÃ³n de tiempo de build
          if [ -n "${{ steps.ccache-restore.outputs.cache-matched-key }}" ]; then
            echo "âš¡ CACHE HIT! Build should take ~10-20 minutes"
          else
            echo "â° NO CACHE - Build will take ~50-60 minutes"
          fi
          echo "=========================================="

      # ------------------------------------------------------------
      # Configure ccache
      # ------------------------------------------------------------
      - name: Configure ccache
        run: |
          ccache --max-size=5G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime
          
          echo "=== Ccache Configuration ==="
          ccache --show-config | grep -E "(max_size|compression|sloppiness)"
          echo ""
          echo "=== Initial Statistics ==="
          ccache --show-stats

      # ------------------------------------------------------------
      # Restore kernel build state
      # ------------------------------------------------------------
      - name: Prepare kernel configuration
        working-directory: kernel-src
        run: |
          if [ -f .config ]; then
            echo "âœ… Using cached .config"
            make olddefconfig
          else
            echo "âš ï¸  Creating new default config"
            make defconfig
          fi

      # ------------------------------------------------------------
      # Build kernel .deb packages
      # ------------------------------------------------------------
      - name: Build .deb kernel packages
        working-directory: kernel-src
        run: |
          # Setup ccache
          export PATH="/usr/lib/ccache:$PATH"
          export CCACHE_DIR="$HOME/.ccache"
          export CC="ccache gcc"
          
          # Optimizations
          export KCFLAGS="-O2 -march=silvermont -mtune=silvermont -pipe -mprefer-vector-width=128"
          export KCPPFLAGS="-D_FORTIFY_SOURCE=2"
          
          echo "=== Build Configuration ==="
          echo "Compiler: $(gcc --version | head -1)"
          echo "Ccache: $(ccache --version | head -1)"
          echo "Cores: $(nproc)"
          echo "Target: Intel x5-Z8300 (Silvermont)"
          echo ""
          
          START_TIME=$(date +%s)
          
          echo "=== Starting Kernel Build ==="
          make -s -j$(nproc) bindeb-pkg 2>&1 | tee build.log
          
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          BUILD_MIN=$((BUILD_TIME / 60))
          BUILD_SEC=$((BUILD_TIME % 60))
          
          echo ""
          echo "=========================================="
          echo "BUILD COMPLETED!"
          echo "Time: ${BUILD_MIN} minutes ${BUILD_SEC} seconds"
          echo "=========================================="
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          
          ls -lh ../*.deb

      # ------------------------------------------------------------
      # Show ccache statistics
      # ------------------------------------------------------------
      - name: Show ccache statistics
        if: always()
        run: |
          echo "=========================================="
          echo "CCACHE FINAL STATISTICS"
          echo "=========================================="
          ccache --show-stats
          echo ""
          
          # Parse stats
          STATS=$(ccache --show-stats)
          DIRECT=$(echo "$STATS" | grep -i "direct" | grep -i "hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          PREPROC=$(echo "$STATS" | grep -i "preprocessed" | grep -i "hit" | grep -oE '[0-9]+' | head -1 || echo "0")
          MISS=$(echo "$STATS" | grep -i "miss" | head -1 | grep -oE '[0-9]+' | head -1 || echo "0")
          
          TOTAL_HITS=$((DIRECT + PREPROC))
          TOTAL=$((TOTAL_HITS + MISS))
          
          echo "ðŸ“Š Compilation Statistics:"
          echo "   Direct cache hits: $DIRECT"
          echo "   Preprocessed hits: $PREPROC"
          echo "   Cache misses: $MISS"
          echo "   Total compilations: $TOTAL"
          
          if [ $TOTAL -gt 0 ]; then
            HIT_RATE=$(awk "BEGIN {printf \"%.1f\", ($TOTAL_HITS * 100) / $TOTAL}")
            echo "   Cache hit rate: ${HIT_RATE}%"
            echo ""
            
            if (( $(echo "$HIT_RATE > 80" | bc -l) )); then
              echo "ðŸŽ‰ EXCELLENT! Cache provided massive speed improvement!"
            elif (( $(echo "$HIT_RATE > 50" | bc -l) )); then
              echo "âœ… GOOD cache performance. Build was notably faster."
            elif (( $(echo "$HIT_RATE > 20" | bc -l) )); then
              echo "âš ï¸  MODERATE cache usage. Some speedup achieved."
            else
              echo "âŒ LOW cache usage. Most files were recompiled."
            fi
          fi
          
          FINAL_SIZE=$(du -sh ~/.ccache 2>/dev/null | cut -f1 || echo "unknown")
          echo ""
          echo "ðŸ’¾ Final cache size: $FINAL_SIZE"
          echo "=========================================="

      # ------------------------------------------------------------
      # Save ccache
      # ------------------------------------------------------------
      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}

      # ------------------------------------------------------------
      # Save kernel metadata
      # ------------------------------------------------------------
      - name: Save kernel metadata
        uses: actions/cache/save@v4
        if: always() && steps.kernel-meta-restore.outputs.cache-hit != 'true'
        with:
          path: |
            kernel-src/.config
            kernel-src/include/config/
            kernel-src/include/generated/
            kernel-src/arch/*/include/generated/
            kernel-src/Module.symvers
            kernel-src/.version
          key: kernel-meta-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}

      # ------------------------------------------------------------
      # Save kernel build tools
      # ------------------------------------------------------------
      - name: Save kernel build tools
        uses: actions/cache/save@v4
        if: always() && steps.kernel-tools-restore.outputs.cache-hit != 'true'
        with:
          path: |
            kernel-src/scripts/basic/
            kernel-src/scripts/kconfig/
            kernel-src/scripts/mod/
            kernel-src/tools/objtool/
          key: kernel-tools-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}

      # ------------------------------------------------------------
      # Save build metrics
      # ------------------------------------------------------------
      - name: Save build metrics
        if: always()
        run: |
          {
            echo "=========================================="
            echo "BUILD METRICS"
            echo "=========================================="
            echo "Date: $(date)"
            echo "Kernel Version: ${{ env.KERNEL_VERSION }}"
            echo "Build Number: #${{ github.run_number }}"
            echo "Git Ref: ${{ github.ref }}"
            echo "Build Time: ${{ env.BUILD_TIME }} seconds ($((${{ env.BUILD_TIME }} / 60))m $((${{ env.BUILD_TIME }} % 60))s)"
            echo ""
            echo "=== Cache Information ==="
            echo "ccache restored from: ${{ steps.ccache-restore.outputs.cache-matched-key }}"
            echo "metadata restored from: ${{ steps.kernel-meta-restore.outputs.cache-matched-key }}"
            echo "tools restored from: ${{ steps.kernel-tools-restore.outputs.cache-matched-key }}"
            echo ""
            echo "=== Ccache Statistics ==="
            ccache --show-stats
            echo "=========================================="
          } > build-metrics.txt

      # ------------------------------------------------------------
      # Generate CHANGELOG
      # ------------------------------------------------------------
      - name: Generate CHANGELOG
        run: |
          cd kernel-src
          {
            echo "# Kernel Build Changelog"
            echo ""
            echo "**Build Date:** $(date)"
            echo "**Kernel Version:** ${{ env.KERNEL_VERSION }}"
            echo "**Build Time:** $((${{ env.BUILD_TIME }} / 60)) minutes $((${{ env.BUILD_TIME }} % 60)) seconds"
            echo ""
            echo "## Recent Changes (Last 30 commits)"
            echo ""
            git log --reverse -n 30 --pretty=format:"- \`%h\` %s (%an)" || echo "No git history available"
          } > ../CHANGELOG.txt

      # ------------------------------------------------------------
      # Collect release files
      # ------------------------------------------------------------
      - name: Collect release files
        run: |
          mkdir -p release
          
          # Copy .deb files
          if ls *.deb 1> /dev/null 2>&1; then
            cp *.deb release/
            echo "âœ… Copied $(ls *.deb | wc -l) .deb files"
          else
            echo "âŒ ERROR: No .deb files found!"
            exit 1
          fi
          
          # Copy documentation
          cp CHANGELOG.txt release/
          cp build-metrics.txt release/
          
          # Generate checksums
          cd release
          sha256sum *.deb > SHA256SUMS.txt
          
          echo ""
          echo "=== Release Files ==="
          ls -lh
          echo ""
          echo "=== Checksums ==="
          cat SHA256SUMS.txt

      # ------------------------------------------------------------
      # Upload artifacts
      # ------------------------------------------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-packages-${{ env.KERNEL_VERSION }}-${{ github.run_number }}
          path: |
            release/*.deb
            release/*.txt
            kernel-src/build.log
            
      # ------------------------------------------------------------
      # Create GitHub Release
      # ------------------------------------------------------------
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.deb
            release/SHA256SUMS.txt
            release/CHANGELOG.txt
            release/build-metrics.txt
          body_path: release/CHANGELOG.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
