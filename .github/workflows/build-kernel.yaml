name: Kernel Debian Ultra-Compact ThinLTO + ZSTD + Clang Opt (v2)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  SCCACHE_DIR: ${{ github.workspace }}/.sccache
  KSRC: kernel-src
  LLVM_VERSION: 19

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # -----------------------------------------------
      # Checkout del Repositorio del Kernel
      # -----------------------------------------------
      - name: Checkout kernel repo
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: ${{ env.KSRC }}
          fetch-depth: 0

      # -----------------------------------------------
      # Calcular núcleos CPU
      # -----------------------------------------------
      - name: Calcular recursos (nproc)
        id: calc
        run: |
          echo "p=$(nproc)" >> $GITHUB_OUTPUT

      # -----------------------------------------------
      # Cache SCCACHE
      # -----------------------------------------------
      - name: Restaurar Cache de SCCACHE
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: sccache-${{ runner.os }}-clang-${{ env.LLVM_VERSION }}-${{ hashFiles(env.KSRC + '/.config') }}
          restore-keys: sccache-${{ runner.os }}-clang-${{ env.LLVM_VERSION }}-

      # -----------------------------------------------
      # Dependencias
      # -----------------------------------------------
      - name: Instalar dependencias
        run: |
          # 1. Instalar LLVM/Clang
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}

          # 2. Paquetes necesarios
          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
            libncurses-dev debhelper dwarves zstd sccache xz-utils \
            util-linux fakeroot dpkg-dev cpio lld-${{ env.LLVM_VERSION }}

          # Configuración SCCACHE
          echo "SCCACHE_DIR=${{ env.SCCACHE_DIR }}" >> $GITHUB_ENV
          echo "SCCACHE_LOG=info" >> $GITHUB_ENV
          echo "${{ github.workspace }}/.sccache" >> $GITHUB_PATH

      # -----------------------------------------------
      # Configuración Kernel (ThinLTO + ZSTD)
      # -----------------------------------------------
      - name: Configuración Kernel
        working-directory: ${{ env.KSRC }}
        run: |
          [ ! -f .config ] && make defconfig

          # Activar Clang LTO Thin
          sed -i '/CONFIG_LTO/d;/CONFIG_THINLTO/d' .config
          echo "CONFIG_LTO_CLANG=y" >> .config
          echo "CONFIG_THINLTO=y" >> .config

          # ZSTD kernel + módulos + initrd
          sed -i \
            -e 's/CONFIG_KERNEL_GZIP=y/# CONFIG_KERNEL_GZIP is not set/' \
            -e 's/# CONFIG_KERNEL_ZSTD is not set/CONFIG_KERNEL_ZSTD=y/' \
            -e 's/CONFIG_MODULE_COMPRESS_GZIP=y/# CONFIG_MODULE_COMPRESS_GZIP is not set/' \
            -e 's/# CONFIG_MODULE_COMPRESS_ZSTD is not set/CONFIG_MODULE_COMPRESS_ZSTD=y/' \
            .config
          echo "CONFIG_RD_ZSTD=y" >> .config

          # Quitar debug pesado
          for opt in DEBUG_KERNEL KASAN KCOV PROFILING FRAME_POINTER COMPILE_TEST; do
            sed -i "s/CONFIG_${opt}=y/# CONFIG_${opt} is not set/" .config
          done

          make olddefconfig

      # -----------------------------------------------
      # Compilación Kernel
      # -----------------------------------------------
      - name: Build Kernel
        working-directory: ${{ env.KSRC }}
        env:
          CC: "sccache clang-${{ env.LLVM_VERSION }}"
          HOSTCC: "clang-${{ env.LLVM_VERSION }}"
          HOSTCXX: "clang++-${{ env.LLVM_VERSION }}"
          LD: "ld.lld-${{ env.LLVM_VERSION }}"
          CFLAGS_KERNEL: -O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing
          KCFLAGS: -O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing
          LLVM: 1
        run: |
          make -j${{ steps.calc.outputs.p }} bindeb-pkg LOCALVERSION="-${{ github.run_number }}-opt"

      # -----------------------------------------------
      # SHA256 + Changelog
      # -----------------------------------------------
      - name: SHA256 + CHANGELOG
        working-directory: ${{ env.KSRC }}
        run: |
          rm -rf ../debout
          mkdir -p ../debout
          mv ../*.deb ../debout/

          cd ../debout
          sha256sum *.deb > SHA256SUMS.txt

          PREV=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")
          if [ -n "$PREV" ]; then
            git log "$PREV"..HEAD --pretty=format:"%h - %s" > CHANGELOG.txt
          else
            git log --reverse --max-count=30 --pretty=format:"%h - %s" > CHANGELOG.txt
          fi

      # -----------------------------------------------
      # Publicar release
      # -----------------------------------------------
      - name: Publicar Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            debout/*.deb
            debout/SHA256SUMS.txt
            debout/CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
