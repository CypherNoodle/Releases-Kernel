name: Build Kernel (.deb) and Upload Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------
  # 0. Prepare environment (install dependencies + cache apt)
  # ------------------------------------------------------------
  setup:
    runs-on: ubuntu-latest
    outputs:
      kernel_version: ${{ steps.detect_version.outputs.KERNEL_VERSION }}
    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src
          fetch-depth: 0

      - name: Detect Kernel Version
        id: detect_version
        working-directory: kernel-src
        run: |
          KERNEL_VERSION=$(awk '
            /^VERSION = /      {v=$3}
            /^PATCHLEVEL = /   {p=$3}
            /^SUBLEVEL = /     {s=$3}
            /^EXTRAVERSION = / {e=$3}
            END {print v "." p "." s e}
          ' Makefile)
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_OUTPUT

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-${{ runner.os }}-v1

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
            libncurses-dev fakeroot dpkg-dev debhelper ccache

      - name: Setup ccache in PATH
        shell: bash
        run: echo "/usr/lib/ccache" >> $GITHUB_PATH

  # ------------------------------------------------------------
  # 1. Build kernel
  # ------------------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src
          fetch-depth: 0

      # Restore caches
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: kernel-src/.ccache
          key: ccache-${{ runner.os }}-${{ needs.setup.outputs.kernel_version }}-${{ hashFiles('kernel-src/Makefile','kernel-src/.config') }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ needs.setup.outputs.kernel_version }}-
            ccache-${{ runner.os }}-
            ccache-

      - name: Show ccache stats
        run: ccache -s

      - name: Restore Kernel Build Cache
        uses: actions/cache@v4
        with:
          path: |
            kernel-src/.tmp_versions
            kernel-src/Module.symvers
            kernel-src/modules.order
            kernel-src/include/generated
            kernel-src/arch/x86/include/generated
            kernel-src/scripts/basic
            kernel-src/scripts/mod
            kernel-src/scripts/kconfig
          key: kernelcache-${{ runner.os }}-${{ needs.setup.outputs.kernel_version }}-${{ hashFiles('kernel-src/Makefile','kernel-src/.config') }}
          restore-keys: |
            kernelcache-${{ runner.os }}-${{ needs.setup.outputs.kernel_version }}-
            kernelcache-${{ runner.os }}-
            kernelcache-

      - name: Build .deb kernel packages
        working-directory: kernel-src
        run: |
          make olddefconfig || make defconfig
          export KCFLAGS="-O2 -march=x86-64-v2 -pipe -fomit-frame-pointer -fno-strict-aliasing -falign-functions=32 -falign-loops=32 -falign-jumps=32"
          export CFLAGS_KERNEL="$KCFLAGS"
          export LDFLAGS_vmlinux="-Wl,-O1"
          echo "::group::Kernel Build Logs"
          make -j"$(nproc)" --output-sync=recurse bindeb-pkg V=0
          echo "::endgroup::"

      - name: Collect .deb and generate SHA256SUMS
        run: |
          mkdir -p build
          cp ../*.deb build/
          cd build
          sha256sum *.deb > SHA256SUMS.txt
          cd ..
          cp ../CHANGELOG.txt build/
          ls -lh build

      - name: Generate CHANGELOG
        working-directory: kernel-src
        run: |
          git log --reverse -n 3 --pretty=format:"%h - %s (%an)" > ../CHANGELOG.txt
          cat ../CHANGELOG.txt

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/*.deb
            build/SHA256SUMS.txt
            build/CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
