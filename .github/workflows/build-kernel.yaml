name: Build Kernel (.deb) and Upload Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # Checkout kernel source
      # ------------------------------------------------------------
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src
          fetch-depth: 0

      # ------------------------------------------------------------
      # Detect kernel version
      # ------------------------------------------------------------
      - name: Detect Kernel Version
        id: detect_version
        working-directory: kernel-src
        run: |
          KERNEL_VERSION=$(awk '
            /^VERSION = /      {v=$3}
            /^PATCHLEVEL = /   {p=$3}
            /^SUBLEVEL = /     {s=$3}
            /^EXTRAVERSION = / {e=$3}
            END {print v "." p "." s e}
          ' Makefile)
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "Detected kernel version: $KERNEL_VERSION"

      # ------------------------------------------------------------
      # Install build dependencies
      # ------------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex libssl-dev libelf-dev \
            libncurses-dev fakeroot dpkg-dev debhelper \
            kmod cpio rsync

      # ------------------------------------------------------------
      # Setup ccache
      # ------------------------------------------------------------
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
            ccache-${{ runner.os }}-

      # ------------------------------------------------------------
      # Configure ccache
      # ------------------------------------------------------------
      - name: Configure ccache
        run: |
          ccache --max-size=2G
          ccache --zero-stats

      # ------------------------------------------------------------
      # Build kernel .deb packages
      # ------------------------------------------------------------
      - name: Build .deb kernel packages
        run: |
          cd kernel-src
          
          # Verificar si existe .config, si no crear uno
          if [ ! -f .config ]; then
            echo "No .config found, creating default config..."
            make defconfig
          else
            echo ".config found, updating..."
            make olddefconfig
          fi
          
          # OptimizaciÃ³n GCC para x86-64-v2
          export KCFLAGS="-O2 -march=x86-64-v2 -pipe"
          export PATH="/usr/lib/ccache:$PATH"
          
          echo "Starting kernel build..."
          make -j$(nproc) bindeb-pkg 2>&1 | tee build.log
          
          echo "Build completed, checking for .deb files..."
          ls -lh ../*.deb || echo "No .deb files found in parent directory"

      # ------------------------------------------------------------
      # Show ccache statistics
      # ------------------------------------------------------------
      - name: Show ccache stats
        run: ccache --show-stats

      # ------------------------------------------------------------
      # Generate CHANGELOG
      # ------------------------------------------------------------
      - name: Generate CHANGELOG
        run: |
          cd kernel-src
          echo "# Kernel Build Changelog" > ../CHANGELOG.txt
          echo "" >> ../CHANGELOG.txt
          echo "Build Date: $(date)" >> ../CHANGELOG.txt
          echo "Kernel Version: ${{ env.KERNEL_VERSION }}" >> ../CHANGELOG.txt
          echo "" >> ../CHANGELOG.txt
          echo "## Recent Changes (Last 30 commits):" >> ../CHANGELOG.txt
          git log --reverse -n 30 --pretty=format:"- %h - %s (%an)" >> ../CHANGELOG.txt || echo "No git history available" >> ../CHANGELOG.txt
          cd ..
          cat CHANGELOG.txt

      # ------------------------------------------------------------
      # Collect .deb and generate SHA256SUMS
      # ------------------------------------------------------------
      - name: Collect .deb and generate SHA256SUMS
        run: |
          mkdir -p release
          
          # Los .deb se generan en el directorio padre de kernel-src
          if ls *.deb 1> /dev/null 2>&1; then
            cp *.deb release/
          else
            echo "ERROR: No .deb files found!"
            exit 1
          fi
          
          cp CHANGELOG.txt release/
          
          cd release
          sha256sum *.deb > SHA256SUMS.txt
          echo "Files ready for release:"
          ls -lh
          cat SHA256SUMS.txt

      # ------------------------------------------------------------
      # Upload artifacts (for debugging)
      # ------------------------------------------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-packages
          path: |
            release/*.deb
            release/SHA256SUMS.txt
            release/CHANGELOG.txt
            kernel-src/build.log

      # ------------------------------------------------------------
      # Upload to release (only on tag push)
      # ------------------------------------------------------------
      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.deb
            release/SHA256SUMS.txt
            release/CHANGELOG.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
