name: Build Kernel (.deb) and Upload Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # ------------------------------------------------------------
    # 1. Checkouts
    # ------------------------------------------------------------
    - name: Checkout main repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: CypherNoodle/linux-Sw1-011
        path: kernel-src

    # ------------------------------------------------------------
    # 2. Install required packages
    # ------------------------------------------------------------
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
          libncurses-dev fakeroot dpkg-dev debhelper ccache

    # ------------------------------------------------------------
    # 2.1 Ensure ccache is in PATH globally
    # ------------------------------------------------------------
    - name: Setup ccache in PATH
      shell: bash
      run: echo "/usr/lib/ccache" >> $GITHUB_PATH   

    # ------------------------------------------------------------
    # 3. Auto-detect kernel version from Makefile
    # ------------------------------------------------------------
    - name: Detect Kernel Version
      id: detect_version
      run: |
        KERNEL_VERSION=$(awk '
          /^VERSION = /      {v=$3}
          /^PATCHLEVEL = /   {p=$3}
          /^SUBLEVEL = /     {s=$3}
          /^EXTRAVERSION = / {e=$3}
          END {print v "." p "." s e}
        ' kernel-src/Makefile)

        echo "Detected kernel version: $KERNEL_VERSION"
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # 4. Smart Cache + ccache
    # ------------------------------------------------------------
    - name: Create ccache directory
      run: mkdir -p kernel-src/.ccache

    - name: Restore Smart CCache
      uses: actions/cache@v4
      with:
        path: kernel-src/.ccache
        key: ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ hashFiles('kernel-src/Makefile', 'kernel-src/.config') }}
        restore-keys: |
          ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
          ccache-${{ runner.os }}-
          ccache-

    - name: Show ccache stats
      run: ccache -s

    # ------------------------------------------------------------
    # 4.1 Optimized Kernel Build Cache
    # ------------------------------------------------------------
    - name: Restore Kernel Build Cache
      uses: actions/cache@v4
      with:
        path: |
          kernel-src/.tmp_versions
          kernel-src/Module.symvers
          kernel-src/modules.order
          kernel-src/include/generated
          kernel-src/arch/x86/include/generated
          kernel-src/scripts/basic
          kernel-src/scripts/mod
          kernel-src/scripts/kconfig
        key: kernelcache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ hashFiles('kernel-src/Makefile','kernel-src/.config') }}
        restore-keys: |
          kernelcache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
          kernelcache-${{ runner.os }}-
          kernelcache-

    # ------------------------------------------------------------
    # 5. Generate CHANGELOG
    # ------------------------------------------------------------
    - name: Generate CHANGELOG
      run: |
        cd kernel-src
        git log --reverse -n 3 --pretty=format:"%h - %s (%an)" > ../CHANGELOG.txt
        cd ..
        cat CHANGELOG.txt

    # ------------------------------------------------------------
    # 6. Build kernel .deb packages
    # ------------------------------------------------------------
    - name: Build .deb kernel packages
      run: |
        cd kernel-src
        make olddefconfig || make defconfig

        echo "::group::Kernel Build Logs"
        make -j"$(nproc)" bindeb-pkg V=0
        echo "::endgroup::"

    # ------------------------------------------------------------
    # 7. Collect artifacts + SHA256SUMS
    # ------------------------------------------------------------
    - name: Collect .deb and generate SHA256SUMS
      run: |
        mkdir -p build
        cp kernel-src/../*.deb build/
        cd build
        sha256sum *.deb > SHA256SUMS.txt
        cd ..
        cp CHANGELOG.txt build/
        ls -lh build

    # ------------------------------------------------------------
    # 8. Upload all artifacts to Release
    # ------------------------------------------------------------
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.deb
          build/SHA256SUMS.txt
          build/CHANGELOG.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
