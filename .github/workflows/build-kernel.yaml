name: Build Kernel (.deb) and Upload Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # Checkout kernel source
      # ------------------------------------------------------------
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src
          fetch-depth: 0

      # ------------------------------------------------------------
      # Detect kernel version
      # ------------------------------------------------------------
      - name: Detect Kernel Version
        id: detect_version
        working-directory: kernel-src
        run: |
          KERNEL_VERSION=$(awk '
            /^VERSION = /      {v=$3}
            /^PATCHLEVEL = /   {p=$3}
            /^SUBLEVEL = /     {s=$3}
            /^EXTRAVERSION = / {e=$3}
            END {print v "." p "." s e}
          ' Makefile)
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          echo "version=$KERNEL_VERSION" >> $GITHUB_OUTPUT
          echo "Detected kernel version: $KERNEL_VERSION"
          
          # Hash del .config para cachÃ© mÃ¡s preciso
          if [ -f .config ]; then
            CONFIG_HASH=$(sha256sum .config | cut -d' ' -f1 | cut -c1-8)
          else
            CONFIG_HASH="noconfig"
          fi
          echo "CONFIG_HASH=$CONFIG_HASH" >> $GITHUB_ENV
          echo "config_hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          
          # Hash de los archivos fuente mÃ¡s importantes para cache key
          SOURCE_HASH=$(find . -name "*.c" -o -name "*.h" | sort | xargs sha256sum | sha256sum | cut -d' ' -f1 | cut -c1-8)
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Cache de dependencias APT
      # ------------------------------------------------------------
      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: ~/apt-cache
          key: apt-${{ runner.os }}-v3
          restore-keys: |
            apt-${{ runner.os }}-

      # ------------------------------------------------------------
      # Install build dependencies
      # ------------------------------------------------------------
      - name: Install build dependencies
        run: |
          if [ -d ~/apt-cache ]; then
            echo "Restoring APT cache..."
            sudo cp -r ~/apt-cache/* /var/cache/apt/archives/ 2>/dev/null || true
          fi
          
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc libssl-dev libelf-dev libncurses-dev \
            debhelper kmod cpio ccache libdw-dev
          
          echo "Saving APT cache..."
          mkdir -p ~/apt-cache
          sudo cp -r /var/cache/apt/archives/*.deb ~/apt-cache/ 2>/dev/null || true

      # ------------------------------------------------------------
      # Cache de ccache (compilaciÃ³n incremental)
      # CLAVE: Removemos github.sha para que sea reutilizable entre builds
      # ------------------------------------------------------------
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ steps.detect_version.outputs.version }}-${{ steps.detect_version.outputs.config_hash }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ steps.detect_version.outputs.version }}-
            ccache-${{ runner.os }}-

      # ------------------------------------------------------------
      # Cache de metadatos del kernel (NO archivos .o)
      # Los .o se manejan via ccache que SÃ detecta cambios
      # ------------------------------------------------------------
      - name: Cache kernel build metadata
        uses: actions/cache@v4
        with:
          path: |
            kernel-src/.config
            kernel-src/include/config/
            kernel-src/include/generated/
            kernel-src/arch/*/include/generated/
            kernel-src/scripts/
            kernel-src/.cache.mk
            kernel-src/Module.symvers
            kernel-src/.version
          key: kernel-meta-${{ runner.os }}-${{ steps.detect_version.outputs.version }}-${{ steps.detect_version.outputs.config_hash }}-v3
          restore-keys: |
            kernel-meta-${{ runner.os }}-${{ steps.detect_version.outputs.version }}-${{ steps.detect_version.outputs.config_hash }}-
            kernel-meta-${{ runner.os }}-${{ steps.detect_version.outputs.version }}-

      # ------------------------------------------------------------
      # Cache de herramientas compiladas (scripts/basic, etc)
      # ------------------------------------------------------------
      - name: Cache kernel build tools
        uses: actions/cache@v4
        with:
          path: |
            kernel-src/scripts/basic/
            kernel-src/scripts/kconfig/
            kernel-src/scripts/mod/
            kernel-src/tools/objtool/
          key: kernel-tools-${{ runner.os }}-${{ env.KERNEL_VERSION }}-v2
          restore-keys: |
            kernel-tools-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
            kernel-tools-${{ runner.os }}-

      # ------------------------------------------------------------
      # Configure ccache
      # ------------------------------------------------------------
      - name: Configure ccache
        run: |
          ccache --max-size=5G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime
          ccache --zero-stats
          echo "Ccache initial stats:"
          ccache --show-stats

      # ------------------------------------------------------------
      # Restore kernel build state
      # ------------------------------------------------------------
      - name: Restore kernel build state
        working-directory: kernel-src
        run: |
          echo "Checking cached build state..."
          
          # Verificar archivos cacheados
          if [ -f .config ]; then
            echo "âœ“ Found cached .config"
            make olddefconfig
          else
            echo "âœ— No cached config, creating default..."
            make defconfig
          fi
          
          if [ -f Module.symvers ]; then
            echo "âœ“ Found cached Module.symvers"
          else
            echo "âœ— No cached Module.symvers"
          fi
          
          if [ -d include/generated ]; then
            echo "âœ“ Found cached generated headers"
            ls -la include/generated/ | head -10
          else
            echo "âœ— No cached generated headers"
          fi
          
          # Contar archivos .o cacheados
          OBJ_COUNT=$(find . -name "*.o" 2>/dev/null | wc -l)
          echo "âœ“ Found $OBJ_COUNT cached object files"
          
          if [ $OBJ_COUNT -gt 0 ]; then
            echo "ðŸŽ¯ Cache restoration successful! Build should be much faster."
          else
            echo "âš ï¸  No cached objects found. This will be a full build."
          fi

      # ------------------------------------------------------------
      # Build kernel .deb packages
      # ------------------------------------------------------------
      - name: Build .deb kernel packages
        working-directory: kernel-src
        run: |
          # Optimizaciones GCC para Intel x5-Z8300
          export KCFLAGS="-O2 -march=silvermont -mtune=silvermont -pipe -mprefer-vector-width=128 -fstack-protector-strong"
          export KCPPFLAGS="-D_FORTIFY_SOURCE=2"
          export LDFLAGS="-Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now"
          export PATH="/usr/lib/ccache:$PATH"
          export CCACHE_DIR="$HOME/.ccache"
          
          echo "Starting kernel build..."
          echo "Available cores: $(nproc)"
          echo "Optimizations: Silvermont (Intel x5-Z8300)"
          
          # Timestamp de inicio
          START_TIME=$(date +%s)
          
          # Build con mÃ¡s verbosidad para debug
          make -j$(($(nproc) * 2)) bindeb-pkg 2>&1 | tee build.log
          
          # Calcular tiempo de build
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          echo "Build completed in $BUILD_TIME seconds"
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          
          echo "Checking for .deb files..."
          ls -lh ../*.deb || echo "No .deb files found"

      # ------------------------------------------------------------
      # Show ccache statistics
      # ------------------------------------------------------------
      - name: Show ccache stats
        run: |
          echo "=== Ccache Statistics ==="
          ccache --show-stats
          echo ""
          
          # Calcular hit rate
          STATS=$(ccache --show-stats)
          HITS=$(echo "$STATS" | grep "Hits:" | head -1 | awk '{print $2}')
          TOTAL=$(echo "$STATS" | grep "Cacheable calls:" | awk '{print $2}')
          
          if [ ! -z "$HITS" ] && [ ! -z "$TOTAL" ]; then
            HIT_RATE=$(echo "scale=2; ($HITS / $TOTAL) * 100" | bc)
            echo "ðŸ“Š Cache hit rate: ${HIT_RATE}%"
            
            if (( $(echo "$HIT_RATE > 50" | bc -l) )); then
              echo "âœ… Excellent cache performance!"
            elif (( $(echo "$HIT_RATE > 20" | bc -l) )); then
              echo "âš ï¸  Moderate cache usage"
            else
              echo "âŒ Low cache usage - this might be a fresh build"
            fi
          fi

      # ------------------------------------------------------------
      # Save build metrics
      # ------------------------------------------------------------
      - name: Save build metrics
        if: always()
        run: |
          echo "=== Build Metrics ===" > build-metrics.txt
          echo "Build Date: $(date)" >> build-metrics.txt
          echo "Kernel Version: ${{ env.KERNEL_VERSION }}" >> build-metrics.txt
          echo "Config Hash: ${{ env.CONFIG_HASH }}" >> build-metrics.txt
          echo "Build Time: ${{ env.BUILD_TIME }} seconds" >> build-metrics.txt
          echo "" >> build-metrics.txt
          echo "=== Ccache Statistics ===" >> build-metrics.txt
          ccache --show-stats >> build-metrics.txt

      # ------------------------------------------------------------
      # Generate CHANGELOG
      # ------------------------------------------------------------
      - name: Generate CHANGELOG
        run: |
          cd kernel-src
          echo "# Kernel Build Changelog" > ../CHANGELOG.txt
          echo "" >> ../CHANGELOG.txt
          echo "Build Date: $(date)" >> ../CHANGELOG.txt
          echo "Kernel Version: ${{ env.KERNEL_VERSION }}" >> ../CHANGELOG.txt
          echo "Build Time: ${{ env.BUILD_TIME }} seconds" >> ../CHANGELOG.txt
          echo "" >> ../CHANGELOG.txt
          echo "## Recent Changes (Last 30 commits):" >> ../CHANGELOG.txt
          git log --reverse -n 30 --pretty=format:"- %h - %s (%an)" >> ../CHANGELOG.txt || echo "No git history available" >> ../CHANGELOG.txt
          cd ..
          cat CHANGELOG.txt

      # ------------------------------------------------------------
      # Collect .deb and generate SHA256SUMS
      # ------------------------------------------------------------
      - name: Collect .deb and generate SHA256SUMS
        run: |
          mkdir -p release
          
          if ls *.deb 1> /dev/null 2>&1; then
            cp *.deb release/
          else
            echo "ERROR: No .deb files found!"
            exit 1
          fi
          
          cp CHANGELOG.txt release/
          [ -f build-metrics.txt ] && cp build-metrics.txt release/
          
          cd release
          sha256sum *.deb > SHA256SUMS.txt
          echo "Files ready for release:"
          ls -lh
          cat SHA256SUMS.txt

      # ------------------------------------------------------------
      # Upload artifacts (for debugging)
      # ------------------------------------------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-packages-${{ env.KERNEL_VERSION }}
          path: |
            release/*.deb
            release/SHA256SUMS.txt
            release/CHANGELOG.txt
            release/build-metrics.txt
            kernel-src/build.log
            
      # ------------------------------------------------------------
      # Upload to release (only on tag push)
      # ------------------------------------------------------------
      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.deb
            release/SHA256SUMS.txt
            release/CHANGELOG.txt
            release/build-metrics.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
