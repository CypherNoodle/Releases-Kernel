name: Build Kernel (.deb) and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
      
env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  SCCACHE_DIR: ${{ github.workspace }}/.sccache
  LLVM_VERSION: 19
  BUILD_DIR: ${{ github.workspace }}/build

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # 1) Checkouts
      # ------------------------------
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: kernel-src

      # ------------------------------
      # 2) Install dependencies
      # ------------------------------
      - name: Install build dependencies
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}
          sudo apt update
          sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
            libncurses-dev debhelper dwarves fakeroot dpkg-dev cpio zstd xz-utils linux-libc-dev ccache sccache \
            llvm-${{ env.LLVM_VERSION }} llvm-${{ env.LLVM_VERSION }}-tools lld-${{ env.LLVM_VERSION }}
          sudo ln -sf /usr/bin/ld.lld-${{ env.LLVM_VERSION }} /usr/bin/ld.lld
          echo "SCCACHE_DIR=${{ env.SCCACHE_DIR }}" >> $GITHUB_ENV
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
          echo "SCCACHE_LOG=info" >> $GITHUB_ENV

      # ------------------------------
      # 3) Setup ccache
      # ------------------------------
      - name: Setup ccache
        run: |
          mkdir -p $CCACHE_DIR $SCCACHE_DIR
          ccache -s || true

      # ------------------------------
      # 4) Kernel configuration
      # ------------------------------
      - name: Prepare kernel config
        working-directory: kernel-src
        run: |
          if [ ! -f .config ]; then
            echo "âŒ .config not found, generating defconfig"
            make defconfig
          fi
          sha256sum .config

      # ------------------------------
      # 5) Build kernel (.deb) with ThinLTO
      # ------------------------------
      - name: Build .deb packages
        working-directory: kernel-src
        env:
          CC: "sccache clang-${{ env.LLVM_VERSION }}"
          HOSTCC: "clang-${{ env.LLVM_VERSION }}"
          HOSTCXX: "clang++-${{ env.LLVM_VERSION }}"
          LD: "ld.lld-${{ env.LLVM_VERSION }}"
          KCFLAGS: "-O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing -flto=thin"
          KBUILD_LDFLAGS: "-flto=thin"
          LDFLAGS: "-flto=thin"
        run: |
          mkdir -p $BUILD_DIR
          make olddefconfig
          make -j$(nproc) -s CC=gcc bindeb-pkg

      # ------------------------------
      # 6) Collect .deb + SHA256SUMS + CHANGELOG
      # ------------------------------
      - name: Collect artifacts
        run: |
          mkdir -p $BUILD_DIR
          cp ../*.deb $BUILD_DIR/
          cd $BUILD_DIR
          sha256sum *.deb > SHA256SUMS.txt
          git -C ${{ github.workspace }}/kernel-src log --reverse -n 10 --pretty=format:"%h - %s (%an)" > CHANGELOG.txt
          cd ..
          ls -lh $BUILD_DIR

      # ------------------------------
      # 7) Upload Release
      # ------------------------------
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            $BUILD_DIR/*.deb
            $BUILD_DIR/SHA256SUMS.txt
            $BUILD_DIR/CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
