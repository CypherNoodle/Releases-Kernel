name: Kernel Debian Ultra-Compact ThinLTO + ZSTD + Clang Opt (v2)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  SCCACHE_DIR: ${{ github.workspace }}/.sccache
  KSRC: kernel-src
  LLVM_VERSION: 19

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # ----------------------------------------------------
      # CHECKOUT REAL DEL KERNEL (INCLUYENDO .config)
      # ----------------------------------------------------
      - name: Checkout kernel repo
        uses: actions/checkout@v4
        with:
          repository: CypherNoodle/linux-Sw1-011
          path: ${{ env.KSRC }}
          fetch-depth: 0

      # DEBUG: Confirmar que el .config existe y está bien
      - name: Mostrar .config real (debug)
        run: |
          echo "===== .config REAL DEL REPO ====="
          ls -l ${{ env.KSRC }}/.config
          head -n 20 ${{ env.KSRC }}/.config || true

      # ----------------------------------------------------
      # NPROC
      # ----------------------------------------------------
      - name: Calcular recursos (nproc)
        id: calc
        run: |
          echo "p=$(nproc)" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # CACHE SCCACHE (IMPORTANTE: YA NO USA hashFiles!!!)
      # ----------------------------------------------------
      - name: Restaurar Cache de SCCACHE
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: sccache-${{ runner.os }}-clang-${{ env.LLVM_VERSION }}

      # ----------------------------------------------------
      # DEPENDENCIAS
      # ----------------------------------------------------
      - name: Instalar dependencias
        run: |
          # LLVM/Clang
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ env.LLVM_VERSION }}

          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
            libncurses-dev debhelper dwarves zstd sccache xz-utils util-linux \
            fakeroot dpkg-dev cpio lld-${{ env.LLVM_VERSION }} \
            llvm-${{ env.LLVM_VERSION }} llvm-${{ env.LLVM_VERSION }}-tools

          sudo ln -sf /usr/bin/ld.lld-${{ env.LLVM_VERSION }} /usr/bin/ld.lld

          echo "SCCACHE_DIR=${{ env.SCCACHE_DIR }}" >> $GITHUB_ENV
          echo "SCCACHE_LOG=info" >> $GITHUB_ENV
          echo "${{ github.workspace }}/.sccache" >> $GITHUB_PATH

      # ----------------------------------------------------
      # CONFIG DEL KERNEL → USAR TU .config SIN DESTRUIRLO
      # ----------------------------------------------------
      - name: Configuración Kernel
        working-directory: ${{ env.KSRC }}
        run: |
          # Asegurar que usa TU .config del repo
          yes "" | make oldconfig

          # LTO Thin
          scripts/config --enable LTO_CLANG
          scripts/config --enable THINLTO
          scripts/config --disable LTO_NONE

          # ZSTD en kernel, módulos e initrd
          scripts/config --enable KERNEL_ZSTD
          scripts/config --enable MODULE_COMPRESS_ZSTD
          scripts/config --enable RD_ZSTD

          # Desactivar debug pesado
          for opt in DEBUG_KERNEL KASAN KCOV PROFILING FRAME_POINTER COMPILE_TEST; do
            scripts/config --disable $opt
          done

          # Aplicar nuevos defaults
          yes "" | make olddefconfig

      # ----------------------------------------------------
      # COMPILACIÓN
      # ----------------------------------------------------
      - name: Build Kernel
        working-directory: ${{ env.KSRC }}
        env:
          CC: "sccache clang-${{ env.LLVM_VERSION }}"
          HOSTCC: "clang-${{ env.LLVM_VERSION }}"
          HOSTCXX: "clang++-${{ env.LLVM_VERSION }}"
          LD: "ld.lld-${{ env.LLVM_VERSION }}"
          CFLAGS_KERNEL: -O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing
          KCFLAGS: -O3 -march=x86-64-v2 -funroll-loops -fstrict-aliasing
          LLVM: 1
        run: |
          make -j${{ steps.calc.outputs.p }} bindeb-pkg LOCALVERSION="-${{ github.run_number }}-opt"

      # ----------------------------------------------------
      # SHA256 + CHANGELOG
      # ----------------------------------------------------
      - name: SHA256 + CHANGELOG
        working-directory: ${{ env.KSRC }}
        run: |
          rm -rf ../debout
          mkdir -p ../debout
          mv ../*.deb ../debout/

          cd ../debout
          sha256sum *.deb > SHA256SUMS.txt

          PREV=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")
          if [ -n "$PREV" ]; then
            git log "$PREV"..HEAD --pretty=format:"%h - %s" > CHANGELOG.txt
          else
            git log --reverse --max-count=30 --pretty=format:"%h - %s" > CHANGELOG.txt
          fi

      # ----------------------------------------------------
      # RELEASE
      # ----------------------------------------------------
      - name: Publicar Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            debout/*.deb
            debout/SHA256SUMS.txt
            debout/CHANGELOG.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
