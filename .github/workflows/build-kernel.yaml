name: Build Kernel (.deb) and Upload Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # ------------------------------------------------------------
    # 1. Checkouts
    # ------------------------------------------------------------
    - name: Checkout main repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: CypherNoodle/linux-Sw1-011
        path: kernel-src

    # ------------------------------------------------------------
    # 2. Install required packages
    # ------------------------------------------------------------
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex libssl-dev libelf-dev libdw-dev \
          libncurses-dev fakeroot dpkg-dev debhelper ccache

    # ------------------------------------------------------------
    # 3. Auto-detect kernel version from Makefile
    # ------------------------------------------------------------
    - name: Detect Kernel Version
      id: detect_version
      run: |
        KERNEL_VERSION=$(awk '
          /^VERSION = /      {v=$3}
          /^PATCHLEVEL = /   {p=$3}
          /^SUBLEVEL = /     {s=$3}
          /^EXTRAVERSION = / {e=$3}
          END {print v "." p "." s e}
        ' kernel-src/Makefile)

        echo "Detected kernel version: $KERNEL_VERSION"
        echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # 4. Smart Cache + ccache
    # ------------------------------------------------------------

    # Needed so the cache path exists before restoring
    - name: Create ccache directory
      run: mkdir -p kernel-src/.ccache

    - name: Restore Smart CCache
      uses: actions/cache@v4
      with:
        path: kernel-src/.ccache
        key: ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ hashFiles('kernel-src/Makefile', 'kernel-src/.config') }}
        restore-keys: |
          ccache-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
          ccache-${{ runner.os }}-
          ccache-

    - name: Enable ccache
      run: |
        export PATH="/usr/lib/ccache:$PATH"
        ccache -s

    # ------------------------------------------------------------
    # 4.1 Kernel Modules Cache (NEW)
    # ------------------------------------------------------------
    - name: Restore Kernel Modules Cache
      uses: actions/cache@v4
      with:
        path: |
          kernel-src/.tmp_versions
          kernel-src/Module.symvers
          kernel-src/modules.order
          kernel-src/**/*.o
        key: modules-${{ runner.os }}-${{ env.KERNEL_VERSION }}-${{ hashFiles('kernel-src/Makefile','kernel-src/.config') }}
        restore-keys: |
          modules-${{ runner.os }}-${{ env.KERNEL_VERSION }}-
          modules-${{ runner.os }}-
          modules-

    # ------------------------------------------------------------
    # 5. Auto Changelog
    # ------------------------------------------------------------
    - name: Generate Changelog
      id: changelog
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        PREV_TAG="$(git describe --tags --abbrev=0 "${TAG_NAME}^" 2>/dev/null || true)"

        if [ -n "$PREV_TAG" ]; then
          git log --pretty=format:"%h - %s (%an)" $PREV_TAG..$TAG_NAME > CHANGELOG.txt
        else
          git log --pretty=format:"%h - %s (%an)" > CHANGELOG.txt
        fi

        cat CHANGELOG.txt

    # ------------------------------------------------------------
    # 6. Build kernel .deb packages
    # ------------------------------------------------------------
    - name: Build .deb kernel packages
      run: |
        cd kernel-src
        make olddefconfig || make defconfig

        echo "::group::Kernel Build Logs"
        make -j"$(nproc)" bindeb-pkg V=0
        echo "::endgroup::"

    # ------------------------------------------------------------
    # 7. Collect artifacts + SHA256SUMS
    # ------------------------------------------------------------
    - name: Collect .deb and generate SHA256SUMS
      run: |
        mkdir -p build
        cp kernel-src/../*.deb build/
        cd build
        sha256sum *.deb > SHA256SUMS.txt
        cd ..
        cp CHANGELOG.txt build/
        ls -lh build

    # ------------------------------------------------------------
    # 8. Upload to Release
    # ------------------------------------------------------------
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/*.deb
          build/SHA256SUMS.txt
          build/CHANGELOG.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
